# 1.2 Browser
## 1.2.1 Структурная схема
````
┌───────────────────────────────────────────────────────────────┐
│                        Веб-браузер                            │
│                                                               │
│  ┌─────────────┐    ┌─────────────┐    ┌──────────────────┐   │
│  │  Пользова-  │    │             │    │                  │   │
│  │  тельский   │◄──►│    Ядро     │◄──►│   Сетевые        │   │
│  │  интерфейс  │    │  браузера   │    │   компоненты     │   │
│  └─────────────┘    │             │    │                  │   │
│                     └─────────────┘    └──────────────────┘   │
│                            ▲                   ▲              │
│                            │                   │              │
│                     ┌──────┴──────┐    ┌───────┴───────┐      │
│                     │             │    │               │      │
│                     │  Движок     │    │  Хранение     │      │
│                     │  рендеринга │    │  данных       │      │
│                     │             │    │               │      │
│                     └──────┬──────┘    └───────┬───────┘      │
│                            │                   │              │
│                     ┌──────▼──────┐    ┌───────▼───────┐      │
│                     │             │    │               │      │
│                     │  JavaScript │    │  Безопасность │      │
│                     │  интерпре-  │    │  и проверки   │      │
│                     │  татор      │    │               │      │
│                     └─────────────┘    └───────────────┘      │
│                                                               │
└───────────────────────────────────────────────────────────────┘
````
### 1.2.1.1 Пользовательский интерфейс

Интерфейс, через который пользователь взаимодействует с браузером:
* Строка с полем ввода URL
* Кнопка перезагрузки страницы
* и т.п.

### 1.2.1.2 Ядро браузера (браузерный движок)
Ядро браузера aka браузерный движок - браузерная платформа, уже готовый браузер, поверх которого могут создаваться кастомные браузеры: удаляется лишнее, например, трекеры и добавляется что-то свое.

---

Так например есть браузерный движок `Chromium`, поверх которого построены браузеры - Google Chrome, Brave, Microsoft Edge ...

`Chromium` появился в 2008 г. и изначально opensource проект, исходники которого можно глянуть [здесь](https://chromium.googlesource.com/chromium/src)

Браузеры на движке `Chromium` занимают около 80% рынка.

---

Также существует движок `Gecko`, появился в 1998 г.

На этом движке работает Firefox, Tor и LibreWolf.

---

Основное различие в архитектуре. У `Chromium` она многопоточная, в то время как у `Gecko` гибридная (комбинация однопоточной и многопоточной). Как результат - `Gecko` в среднем меньше потребляет RAM, однако `Chromium` засчет полной многопточности является более безопасным и устойчивым к падениям.  
### 1.2.1.3 Движок рендеринга и стадии рендера
Выполняет ключевую часть работы браузера: рендеринг и ререндеринг содержимого страниц.

Список основных движков рендера:
1. `Blink` (`Chromium`)
2. `Quantum` (`Gecko`)
3. `WebKit` (в браузерах от Apple - Safari и во всех браузерах под iOS и IPadOS)

**Стадии рендера (DOM, CSSOM, Render tree, style calculation, layout, paint, composite)**

### 1.2.1.4 JavaScript интерпретатор
Список основных JS-интерпретаторов:
1. `V8` (`Chromium`)
2. `SpiderMonkey` (`Gecko`)
3. `Nitro` (в браузерах от Apple - Safari и во всех браузерах под iOS и IPadOS)

### 1.2.1.5 Безопасность и проверки (компоненты безопасности)
**Sandbox**

Технология, которая изолирует процессы браузера (вкладки, расширения) от основной операционной системы и друг от друга.

* Как работает? Браузер работает на двух уровнях:
1. Брокер (Broker Process): Имеет полные права на доступ к ОС. Управляет интерфейсом, вкладками и сетью.
2. Процессы-песочницы (Renderer Processes): В них работает код веб-страниц. Эти процессы имеют крайне ограниченные права. Они не могут напрямую читать файлы на диске, получать доступ к камере или микрофону без явного разрешения пользователя, вызванного через брокер.
* Зачем нужно? 

Если вы посетите вредоносный сайт, и он найдет уязвимость в движке рендеринга, атака будет заперта внутри песочницы. Злоумышленник не сможет установить вирус, удалить файлы или получить доступ к вашим данным на диске.
* Реализация

В Chrome/Edge используется песочница на уровне ОС Windows (на базе технологии Sandbox). В Firefox и Safari также реализованы свои модели изоляции.

---

**Изоляция источников (Site Isolation)**
   
Это логическое развитие идеи песочницы и является функцией, которая гарантирует, что страницы с разных веб-сайтов всегда будут работать в разных процессах.

* Как работало раньше? 

Несколько вкладок с одного сайта (например, разные почты Gmail) могли делить один процесс.

* Зачем нужно? 

Для защиты от атак типа Spectre, которые теоретически могли позволить одному сайту прочитать данные другого сайта, загруженного в том же процессе. Теперь, даже если сайт evil.com и ваш банк bank.com открыты в одном окне, их код выполняется в абсолютно изолированных друг от друга процессах. evil.com не может "дотянуться" до данных bank.com.

---

**Механизм контроля доступа - CORS (Cross-Origin Resource Sharing)**

Правило безопасности браузера, которое по умолчанию запрещает веб-странице делать запросы к другому домену (источнику, origin), отличному от того, с которого она загружена.

---

**Политика одинакового источника (Same-Origin Policy - SOP)**

Базовый принцип, на котором построена безопасность веба. Он ограничивает возможности скриптов одной страницы взаимодействовать с ресурсами другой страницы, если у них разный "источник" (сочетание протокола, домена и порта).

---

**Защита конфиденциальности (Privacy Features)**

Современные браузеры активно внедряют функции для защиты от слежки:

* Блокировка трекеров (Tracking Protection): Браузер (особенно Firefox и Safari) автоматически блокирует скрипты и запросы от известных трекеров, которые собирают данные о вашем поведении в интернете.


* Умная блокировка кук (Intelligent Tracking Prevention - ITP в Safari): Автоматически изолирует и удаляет куки, используемые для межсайтового отслеживания.


* Защита от fingerprinting (создания цифрового отпечатка): Браузеры пытаются ограничить доступ к неочевидным параметрам системы (списку установленных шрифтов, точным характеристикам GPU и т.д.), которые используются для уникальной идентификации пользователя без его ведома.

---

**Безопасность расширений (Extension Security)**
* Магазины расширений: Chrome Web Store, Firefox Add-ons проводят модерацию и проверку расширений на вредоносный код.
* Разрешения (Permissions): Перед установкой расширение должно запросить у пользователя доступ к данным сайтов, вкладкам и т.д. Пользователь видит, к чему расширение получит доступ.
* Изоляция: Расширения часто работают в своих собственных изолированных процессах.
## 1.2.4 API
### 1.2.4.1 Event Loop
### 1.2.4.1 DOM
### 1.2.4.2 Local storage
### 1.2.4.3 Session storage
### 1.2.4.4 Browser cache
### 1.2.4.5 Cookie